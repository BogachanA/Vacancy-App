{% extends 'newReservation.html' %}


{% block head2 %}
<style type="text/css">
    @keyframes shadowThrob {
        from {box-shadow: inset 0 0 0px rgba(0,0,0,0);}
        to {box-shadow: inset 0 0 12px rgba(0,0,0,0.7);}
    }
    .classBox{
        box-shadow: 0 0 3px 1px rgba(0,0,0,0.2);
        text-align: left;
        vertical-align: center;
        color: #000000;
        font-family: 'Raleway', sans-serif;
        transition: all 0.7s;
        border-radius: 3px;
        background: rgb(255,255,255);
        background: -moz-linear-gradient(217deg, rgba(255,255,255,1) 0%, rgba(205,199,207,0.604079131652661) 49%, rgba(255,255,255,1) 100%);
        background: -webkit-linear-gradient(217deg, rgba(255,255,255,1) 0%, rgba(205,199,207,0.604079131652661) 49%, rgba(255,255,255,1) 100%);
        background: linear-gradient(217deg, rgba(255,255,255,1) 0%, rgba(205,199,207,0.604079131652661) 49%, rgba(255,255,255,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#ffffff",endColorstr="#ffffff",GradientType=1);
    }
    .classBox:hover{
    }
    .classBox.label{
        text-shadow: 0 0 #000000;
        transition: text-shadow 0.6s;
    }
    .classBox.label:hover{
        text-shadow: 3px 3px #000000;
    }
    .classBox.clashing{
        background: rgb(255,101,21);
        background: -moz-linear-gradient(216deg, rgba(255,101,21,1) 0%, rgba(253,29,29,1) 50%, rgba(252,176,69,1) 100%);
        background: -webkit-linear-gradient(216deg, rgba(255,101,21,1) 0%, rgba(253,29,29,1) 50%, rgba(252,176,69,1) 100%);
        background: linear-gradient(216deg, rgba(255,101,21,1) 0%, rgba(253,29,29,1) 50%, rgba(252,176,69,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#ff6515",endColorstr="#fcb045",GradientType=1);
    }
    .classBox.available{
        background: rgb(32,143,4);
        background: -moz-linear-gradient(217deg, rgba(32,143,4,1) 0%, rgba(130,194,127,1) 61%, rgba(49,244,174,1) 100%);
        background: -webkit-linear-gradient(217deg, rgba(32,143,4,1) 0%, rgba(130,194,127,1) 61%, rgba(49,244,174,1) 100%);
        background: linear-gradient(217deg, rgba(32,143,4,1) 0%, rgba(130,194,127,1) 61%, rgba(49,244,174,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#208f04",endColorstr="#31f4ae",GradientType=1);
    }
    .classBox.shadowSelect{
        animation: shadowThrob 0.4s forwards;
        animation-direction: revert;
    }
    .classCheckbox{
        visibility: hidden;
    }

</style>
{% endblock %}

{% block innerContent %}
    {% if clError %}
    <div class="align-items-center" id="clashMessage">
        <span class="icon icon-warning" style="size: 50px;"></span><br>
        {% for c in clist %}
            {% if c.1|length != 0 %}
                <p class="clashClass"><span class="icon ui-icon-bullet"></span> Conflict for: {{ c.0.name }}</p>
                {% for r in c.1 %}
                    <p class="clashClass" id="{{ c.0.name }}clash{{ forloop.counter }}">
                        "{{ r.description }}" reservation for {{ r.res_date_start }}
                    </p><br>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </div>
    <hr><br>
    {% endif %}
    <form id="resForm" method="post" action="{% url 'new_reservation' %}">
        {% csrf_token %}
        {% for clash in clist %}
            <div class="inputField classBox {% if clash.1|length == 0 %}available{% else %}clashing{% endif %}" id="{{ clash.0.name }}Box"
                 style="width:100%;margin: 3px; padding: 2% 2% 0% 2%;">
                <label class="classLabel" style=""><input type="checkbox" class="inputField classCheckbox"
                       id="{{ clash.0.name }}Checkbox"
                       value="{{ clash.0.name }}">{{ clash.0.name }}</label>
                <p class="classBoxCapacity" style="float: right; display: inline;">{% if resType == '1' %} {{ clash.0.exam_capacity }} {% else %} {{ clash.0.capacity }} {% endif %}</p>
            </div>
        {% endfor %}
        <hr>
        {% for o in others %}
            <div class="inputField classBox otherBox" id="{{ o.name }}Box"
                 style="width:100%;margin: 10px; padding: 2% 2% 0% 2%;">
                <label class="classLabel"><input type="checkbox" class="inputField classCheckbox"
                       id="{{ o.name }}Checkbox"
                       value="{{ o.name }}">{{ o.name }}</label>
                <p class="classBoxCapacity" style="float: right; display: inline;">{% if resType == '1' %} {{ o.exam_capacity }} {% else %} {{ o.capacity }} {% endif %}</p>
            </div>
        {% endfor %}
        <button class="hoverButtons" type="submit" id="submitbutton">Submit</button>
        <input type="hidden" name="next" value="{{next}}">
    </form>
{% endblock %}

{% block step2script %}
<script>
    $(function () {});
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function correctTime(t){
        if (t=='noon') {
            console.log(t)
            return '12:00 pm';
        }
        else if(t.includes(".")) {
            console.log(t)
            return t.replace(/\./g,"");
        }
        else return t;
    }

    function create_post(){
        let classString=""
        $('.classCheckbox').each(function () {
            if ($(this).prop('checked')) {
              classString+=$(this).parent().text()+"-"
            }
        });
        classString=classString.substring(0,classString.length-1);
        console.log(classString);
        var csrftoken = getCookie('csrftoken');

        $.ajax({
            url: "submitRes",
            type: "post", // or "get"
            data: {
                "csrfmiddlewaretoken": csrftoken,
                "desc": "{{ form.desc }}",
                "type": {{ form.type }},
                "capacity": {{ form.capacity }},
                "classList": classString,
                "instructor": "{{ form.instructor }}",
                "proctor": {{ form.proctor }},
                "day": "{{ form.day }}",
                "start": correctTime("{{ form.start }}"),
                "end": correctTime("{{ form.end }}"),
            },
            success: function(json) {
                alert(json["hi"]);
            },
            error: function (xhr,errmsg,err) {
                console.log(xhr + " xhr, err: "+errmsg+" err "+err)
            }
        });
    }

    $(function () {
       $('.classBox').click(function () {
           //console.log($("label input.classCheckbox",this).prop('checked'));
           let box=$("label input.classCheckbox",this);
           if (box.prop('checked')) {
               box.prop('checked',false);
               $(this).removeClass('shadowSelect');
           } else {
               box.prop('checked',true);
               $(this).addClass('shadowSelect');
           }
           $('.classCheckbox').each(function () {
              if ($(this).prop('checked')) {
                  console.log($(this).parent().text());
              }

           });
           console.log("----");

       });
    });
    $('#resForm').on('submit', function(event){
        event.preventDefault();
        console.log("form submitted!")  // sanity check
        create_post();
    });
</script>
{% endblock %}